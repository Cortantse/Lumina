

### 🕒 复杂场景时序（单位：ms）

| 时间 (ms) | 实际活动                          | 前端采集帧                | VAD / 上传                | STT 行为                                 | STD 行为                                               | LLM 行为                      |
| ------- | ----------------------------- | -------------------- | ----------------------- | -------------------------------------- | ---------------------------------------------------- | --------------------------- |
| 0       | 静音                            | 缓冲 frame1 (0–20)     | 无法判断，未启动上传              | —                                      | —                                                    | —                           |
| 10      | 用户开始讲话                        | 继续缓冲 frame1          | 无法判断，还未形成第一帧                    | —                                      | —                                                    | —                           |
| 20      | 人声中                           | frame1 完成 (0–20)     | ✅ VAD 检测到说话 → 上传 frame1 | STT 接收 frame1                          | —                                                    | —                           |
| 40      | 人声中                           | frame2 (20–40)       | ✅ 持续说话 → 上传 frame2      | STT 接收 frame2 → 返回 **partial1** (“打”)  | —                                                    | —                           |
| 60      | 人声中                           | frame3 (40–60)       | ✅ 持续说话 → 上传 frame3      | STT 接收 frame3 → 返回 **partial2** (“打开”) | —                                                    | —                           |
| 70      | 说话暂歇（正在缓冲 frame4）             | 缓冲 frame4 (60–80)    | 无法判断，还未形成完整帧                    | —                                      | —                                                    | —                           |
| 80      | 人声结束后的最后一帧结束                  | frame4 完成 (60–80)    | ✅ 上传 frame4             | STT 接收 frame4                          | —                                                    | —                           |
| 100     | 静音                            | frame5 (80–100)      | ❌ 无人声 → 上传 frame5       | STT 接收 frame5                          | —                                                    | —                           |
| …       | …                             | …                    | …                       | …                                      | …                                                    | …                           |
| 170     | 静音累积 ≥100ms → 触发段落结束          | —                    | ❌ 停止上传                  | 发送 End-of-Stream → **开始 flush**        | —                                                    | —                           |
| \~230   | —                             | —                    | —                       | **STT 返回 final1** (“打开灯并”)             | **STD(on partial2)**: “打开” → **不完整**，不触发 LLM         | —                           |
| 200     | 用户第二次讲话开始                     | 缓冲 frame10 (200–220) | 无法判断                    | —                                      | —                                                    | —                           |
| 240     | 二次讲话首帧完成 → 上传 frame10/frame11 | frame11 (220–240)    | ✅ 上传 frame11            | STT 接收第二段音频 → 返回 **partial3** (“播放”)   | —                                                    | —                           |
| 315     | 二次讲话继续                        | —                    | —                       | STT 返回 **partial4** (“播放音乐”)           | —                                                    | —                           |
| 335     | 第二段静音累积 ≥100ms → 触发段落结束       | —                    | ❌ 停止上传                  | 发送 End-of-Stream → **开始 flush**        | —                                                    | —                           |
| \~395   | —                             | —                    | —                       | **STT 返回 final2** (“播放音乐”)             | **STD(on final2 + 上下文)**: “打开灯并播放音乐” → **完整**，触发 LLM | —                           |
| \~595   | —                             | —                    | —                       | —                                      | —                                                    | **LLM 返回** “好的，已为您打开灯并播放音乐” |

---

#### 关键说明

1. **VAD 必须等 20ms 帧完成后**才能判断“是否有人声”，因此不会在 10ms 立即触发。
2. **partial transcript**（“打”、“打开”、“播放”、“播放音乐”）仅供 UI 滚动展示或 STD 预判，**不**作为触发 LLM 的依据。
3. **final transcript**（“打开灯并”、“播放音乐”）在静音累积 ≥100ms 后 flush，由 STD 判断完整性，最终触发 LLM。
4. 第二次讲话的片段在第一次 flush 之后独立开启新的 VAD+STT 流，STD 结合**全部上下文**做完整性判断。
™
